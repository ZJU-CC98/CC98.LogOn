@using CC98.LogOn.ZjuInfoAuth
@using IdentityServer4.Extensions
@using Microsoft.AspNetCore.Http.Extensions
@using Microsoft.EntityFrameworkCore
@using Microsoft.Extensions.Options
@model CC98.LogOn.ViewModels.Account.RegisterViewModel
@inject IOptions<AppSetting> AppSetting
@inject CC98IdentityDbContext DbContext
@{
	ViewBag.Title = "注册 CC98 账号";
}

<form asp-controller="Account" asp-action="Register" asp-antiforgery="true" method="post">
	<div class="row justify-content-center">
		<div class="col-md-6">
			<div class="form-group">
				<label asp-for="UserName" class="form-control-label"></label>
				<input id="user-name-input" asp-for="UserName" type="text" class="form-control" />
				<span asp-validation-for="UserName" class="text-danger"></span>
				<small class="form-text text-muted">你要注册的 CC98 用户名。用户名在注册后不能修改。<a href="#" data-toggle="modal" data-target="#register-tip-modal">点击此处</a>查看有关用户名的提示和建议。</small>
			</div>
			<div class="form-group">
				<label asp-for="Password" class="form-control-label"></label>
				<input id="password-input" asp-for="Password" type="password" class="form-control" />
				<span asp-validation-for="Password" class="text-danger"></span>
				<small class="form-text text-muted">新 CC98 账户的密码。如果你忘记了密码，你必须通过登录到关联的浙大通行证来修改密码。为关联到浙大通行证的临时账户无法自助修改密码。</small>
			</div>
			<div class="form-group">
				<label asp-for="ConfirmPassword" class="form-control-label"></label>
				<input asp-for="ConfirmPassword" type="password" class="form-control" />
				<span asp-validation-for="ConfirmPassword" class="text-danger"></span>
				<small class="form-text text-muted">请再次输入新 CC98 账户的密码。</small>
			</div>

			@if (User.IsAuthenticatedWith(ZjuInfoOAuthDefaults.AuthenticationScheme))
			{
				var userId = User.GetSubjectId();
				var bindCount = await (from i in DbContext.Users
									   where string.Equals(i.RegisterZjuInfoId, userId, StringComparison.OrdinalIgnoreCase)
									   select i).CountAsync();


				if (bindCount < AppSetting.Value.MaxCC98AccountPerZjuInfoId)
				{
					<div class="form-check">
						<label class="form-check-label">
							<input id="skip-binding-input" asp-for="SkipBinding" type="checkbox" class="form-check-input" /> 暂不绑定到我的浙大通行证
						</label>
						<span asp-validation-for="SkipBinding" cla class="text-danger"></span>
						<small class="form-text text-muted">默认情况下，你注册的账号将自动和你的浙大通行证关联。如果你不希望系统自动进行这样的操作，可以选中上面的复选框。<span class="text-warning">注意：未绑定浙大通行证的账号将不能在论坛中进行大多数交流活动，如发帖、回帖、给他人发送站内短消息等。你可以在稍后通过<q> 激活账号</q>页面将新账号和浙大通行证进行关联。</span></small>
					</div>
				}
				else
				{
					<div class="form-text text-warning">
						<p>
							系统目前限制每个浙大通行证最多可以绑定<strong>@AppSetting.Value.MaxCC98AccountPerZjuInfoId</strong> 个 CC98 账号。你当前登录的浙大通行证账号绑定数量已经达到上限，无法用于激活新账号。你在不激活的情况下继续注册账号，或者<a asp-controller="ZjuInfo" asp-action="LogOn" asp-route-returnUrl="@Context.Request.GetDisplayUrl()">更换浙大通行证账号</a>。
						</p>
						<p>
							注意：未激活的账号将不能在论坛中进行大多数交流活动，如发帖、回帖、给他人发送站内短消息等。你可以在稍后通过<q> 激活账号</q>页面将新账号和浙大通行证进行关联。
						</p>
					</div>
				}

			}
			else
			{
				<div class="form-text text-warning">
					<p>
						你当前没有登录浙大通行证账号，新账号将无法自动激活。你可以在不激活的情况下继续注册账号，或者<a asp-controller="ZjuInfo" asp-action="LogOn" asp-route-returnUrl="@Context.Request.GetDisplayUrl()">更换浙大通行证账号</a>。
					</p>
					<p>
						注意：未绑定浙大通行证的账号将不能在论坛中进行大多数交流活动，如发帖、回帖、给他人发送站内短消息等。你可以在稍后通过<q>激活账号</q>页面将新账号和浙大通行证进行关联。
					</p>
				</div>
			}
			<hr />
			<div asp-validation-summary="ModelOnly"></div>
			<button id="register-button" type="submit" class="btn btn-primary">注册账号</button>
			<button id="register-temp-button" type="submit" class="btn btn-warning">注册临时账号</button>
			<button type="reset" class="btn btn-secondary">清空内容</button>

		</div>
	</div>
</form>

<div id="register-tip-modal" class="modal fade" tabindex="-1" role="dialog">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">账户注册提示</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="关闭">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<p>注册 CC98 账户时，请特别注意用户名要满足下列条件：</p>
				<ul>
					<li>用户名最长只能包含10个字符，并且大部分非标准英文键盘产生的字符（如汉字和中文标点）都算作两个字符，因此，如果是纯汉字的用户名，则只能包含五个汉字。</li>
					<li>用户名内容没有任何实际限制，但请不要注册政治相关、侮辱他人、具有误导性等不良的账号名，管理团队将有权对此类账号进行封禁。</li>
					<li><strong>为了保护你的隐私，我们建议你不要使用你的学工号、真实姓名等个人信息作为账号名。</strong></li>
					<li>账号注册后，用户名将不能更改，因此请谨慎选择你的名称。</li>
				</ul>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
			</div>
		</div>
	</div>
</div>

@section Scripts{

	<script>

		$('#password-input').pwstrength({
			ui: {
				bootstrap4: true,
				showVerdictsInsideProgressBar: true
			},
			common: {
				usernameField: '#user-name-input'
			}
		});

		function switchSkipState() {
			var isSkipBinding = $('#skip-binding-input').prop('checked');
			switchSkipCore(isSkipBinding);
		}

		function switchSkipCore(isSkipBinding) {
			if (isSkipBinding) {
				$('#register-button').hide();
				$('#register-temp-button').show();
			} else {
				$('#register-button').show();
				$('#register-temp-button').hide();
			}
		}

	</script>

}