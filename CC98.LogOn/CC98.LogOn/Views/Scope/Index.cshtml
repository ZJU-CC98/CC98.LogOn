@model IPagedList<AppScope>
@{
	ViewBag.Title = "领域一览";
}

<div class="alert alert-info">
	下表列出了目前 CC98 登录系统支持的所有领域。请注意，这些领域分别由不同的 CC98 或第三方服务创建并使用，要了解每个领域的具体作用和权限，请阅读相关应用和网站的帮助文档。
</div>

<authorize policy="@Policies.OperateApps">
	<a class="btn btn-primary" asp-controller="Scope" asp-action="Create">创建新领域</a>
	<hr />
</authorize>

@if (Model.Any())
{
	<table class="table table-hover table-striped">
		<thead>
			<tr>
				<th>标识</th>
				<th>显示名称</th>
				<th>类型</th>
				<th>关联 API</th>
				<th asp-authorize-policy="@Policies.OperateApps">操作</th>
			</tr>
		</thead>
		<tbody>
			@foreach (var item in Model)
			{
				<tr data-id="@item.Id" data-name="@item.DisplayName">
					<th>@item.Id</th>
					<td>@item.DisplayName</td>
					<td>
						@switch (item.Type)
						{
							case ScopeType.Identity:
								<span class="text-primary">标识</span>
								break;
							case ScopeType.Resource:
								<span class="text-success">资源</span>
								break;
						}
					</td>
					<td>
						@if (item.ApiId != null)
						{
							<span>@item.ApiId</span>
						}
						else
						{
							<span class="text-muted">无</span>
						}
					</td>
					<td asp-authorize-policy="@Policies.OperateApps">
						<div class="btn-group btn-group-sm">
							<a asp-controller="Scope" asp-action="Edit" asp-route-id="@item.Id" class="btn btn-secondary">编辑</a>
							<button class="btn btn-danger" type="button" onclick="deleteScope(this);">删除</button>
						</div>
					</td>
				</tr>
			}
		</tbody>
	</table>

	<pager />

	<form data-ajax="true" data-ajax-failure="handleAjaxFailure(xhr, '#delete-scope-error-text')" asp-controller="Scope" asp-action="Delete" method="post" asp-antiforgery="true" asp-authorize-policy="@Policies.OperateApps">
		<input type="hidden" name="id" id="delete-scope-id-input" />
		<div class="modal fade" id="delete-scope-dialog">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">删除领域确认</h5>
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
						<p>你确定要删除领域 <strong id="delete-scope-name-text"></strong>吗？这个操作无法撤销。删除该领域后，所有应用都不能申请该领域的权限。原有基于该领域运行的服务或者应用可能会无法正常工作。要确认删除，请单击<q>删除领域</q>按钮。</p>
					</div>
					<div class="modal-footer">
						<p id="delete-scope-error-text" class="text-danger"></p>
						<button type="submit" class="btn btn-danger">删除领域</button>
						<button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
					</div>
				</div>
			</div>
		</div>
	</form>

}
else
{
	<p class="text-muted text-center">目前还没有任何领域</p>
}

@section Scripts {

	<script asp-authorize-policy="@Policies.OperateApps">

		function deleteScope(ele) {

			var row = $(ele).closest('tr');

			var id = $(row).data('id');
			var name = $(row).data('name');

			$('#delete-scope-id-input').val(id);
			$('#delete-scope-name-text').text(name);

			$('#delete-scope-dialog').modal();
		}

	</script>

}
